# OpenCode 远程控制测试指南

## 完整测试流程

### 准备工作

**需要的设备**：
- 1 台电脑（运行 OpenCode Desktop）
- 1 部手机（iOS 或 Android）
- 同一个 WiFi 网络

**需要的软件**：
- OpenCode Desktop（已编译）
- Node.js（用于手机端）
- 手机浏览器（Chrome/Safari）

---

## 第一步：启动桌面端服务

### 1.1 编译桌面端（如果还没编译）

```bash
cd myapp
go build -o opencode-desktop
```

### 1.2 启动桌面端应用

```bash
./opencode-desktop
# 或
wails dev
```

### 1.3 启动远程控制服务

**方法 A：通过 UI（推荐）**

1. 打开应用
2. 进入 **设置 > 远程控制**
3. 点击 **启动远程控制**
4. 记下显示的信息

**方法 B：通过控制台**

打开浏览器开发者工具（F12），执行：

```javascript
const info = await window.StartRemoteControl(8080)
console.log('服务器信息:', info)
```

输出示例：
```json
{
  "active": true,
  "port": 8080,
  "token": "a1b2c3d4e5f6...",
  "url": "http://localhost:8080"
}
```

**重要**：复制 `token` 值，手机端需要用到！

### 1.4 验证服务运行

在电脑浏览器测试：

```bash
# 测试 API
curl http://localhost:8080/api/status

# 应该返回：
# {"active":true,"port":8080,"timestamp":1234567890}
```

---

## 第二步：获取电脑 IP 地址

### macOS

```bash
ifconfig | grep "inet " | grep -v 127.0.0.1
```

输出示例：
```
inet 192.168.1.100 netmask 0xffffff00 broadcast 192.168.1.255
```

你的 IP 是：`192.168.1.100`

### Windows

```cmd
ipconfig
```

查找 "无线局域网适配器 WLAN"：
```
IPv4 地址 . . . . . . . . . . . . : 192.168.1.100
```

### Linux

```bash
hostname -I
```

输出：`192.168.1.100`

**记下你的 IP 地址！**

---

## 第三步：启动手机端应用

### 3.1 进入手机端目录

```bash
cd opencode-mobile
```

### 3.2 安装依赖（首次运行）

```bash
npm install
```

### 3.3 启动开发服务器

**方法 A：使用启动脚本（推荐）**

```bash
./start.sh
```

输出：
```
================================
OpenCode Mobile 启动脚本
================================

📱 手机端访问地址：
   http://192.168.1.100:5173

🖥️  桌面端服务地址（需要在手机端输入）：
   http://192.168.1.100:8080

💡 提示：
   1. 确保手机和电脑在同一 WiFi
   2. 在桌面端启动远程控制服务（端口 8080）
   3. 在手机浏览器打开上面的地址
   4. 输入桌面端显示的 Token

================================
正在启动开发服务器...
================================

  VITE v7.3.1  ready in 475 ms

  ➜  Local:   http://localhost:5173/
  ➜  Network: http://192.168.1.100:5173/
```

**方法 B：手动启动**

```bash
npm run dev
```

### 3.4 验证服务运行

在电脑浏览器打开：
```
http://localhost:5173
```

应该能看到 OpenCode Mobile 的连接页面。

---

## 第四步：手机连接

### 4.1 确保手机和电脑在同一 WiFi

检查：
- 手机 WiFi 设置
- 电脑 WiFi 设置
- 确认连接到同一个网络

### 4.2 手机浏览器打开应用

在手机浏览器（Chrome/Safari）输入：
```
http://192.168.1.100:5173
```

（使用你的实际 IP 地址）

### 4.3 输入连接信息

**服务器地址**：
```
http://192.168.1.100:8080
```

**访问令牌**：
```
a1b2c3d4e5f6...
```
（粘贴第一步获取的 token）

### 4.4 点击连接

如果成功，你会看到：
- ✅ 连接成功
- 界面切换到主界面
- 右下角显示 🟢 实时连接

---

## 第五步：功能测试

### 5.1 测试聊天功能

1. 点击 **💬 聊天** 标签
2. 在输入框输入：`你好`
3. 点击 **发送**
4. 观察：
   - ✅ 消息显示在列表中
   - ✅ 显示发送时间
   - ✅ 收到回复（如果桌面端有响应）

### 5.2 测试文件浏览

1. 点击 **📁 文件** 标签
2. 观察：
   - ✅ 显示文件列表
   - ✅ 显示文件夹和文件图标
   - ✅ 显示文件大小
3. 点击文件夹：
   - ✅ 进入文件夹
   - ✅ 显示子文件
4. 点击文件：
   - ✅ 打开文件查看器
   - ✅ 显示文件内容
5. 点击 **返回**：
   - ✅ 返回上级目录

### 5.3 测试终端查看

1. 点击 **💻 终端** 标签
2. 观察：
   - ✅ 显示终端输出
   - ✅ 绿色文本（终端风格）
   - ✅ 自动更新（如果有新输出）
3. 点击 **刷新**：
   - ✅ 手动刷新输出
4. 点击 **清空**：
   - ✅ 清空显示
5. 点击 **自动滚动**：
   - ✅ 切换自动滚动状态

### 5.4 测试 SSE 实时更新

1. 观察右下角状态指示器：
   - ✅ 显示 🟢 实时连接
2. 在桌面端发送消息：
   - ✅ 手机端自动收到（无需刷新）
3. 在桌面端运行命令：
   - ✅ 终端输出自动更新

### 5.5 测试断线重连

1. 关闭桌面端服务：
   ```javascript
   await window.StopRemoteControl()
   ```
2. 观察手机端：
   - ✅ 状态变为 🔴 连接失败
   - ✅ 显示错误信息
3. 重新启动桌面端服务：
   ```javascript
   await window.StartRemoteControl(8080)
   ```
4. 观察手机端：
   - ✅ 自动重连
   - ✅ 状态变为 🟢 实时连接

---

## 第六步：性能测试

### 6.1 延迟测试

1. 在聊天界面发送消息
2. 记录从发送到显示的时间
3. 预期：< 100ms

### 6.2 稳定性测试

1. 保持连接 10 分钟
2. 观察：
   - ✅ 连接保持稳定
   - ✅ 无自动断开
   - ✅ 心跳正常

### 6.3 并发测试

1. 同时打开多个标签
2. 快速切换标签
3. 观察：
   - ✅ 切换流畅
   - ✅ 无卡顿
   - ✅ 数据正确

---

## 常见问题排查

### 问题 1：手机无法访问 http://192.168.1.100:5173

**检查清单**：
- [ ] 手机和电脑在同一 WiFi
- [ ] IP 地址正确
- [ ] 开发服务器正在运行
- [ ] 防火墙允许端口 5173

**解决方案**：

**macOS 防火墙**：
```bash
# 查看防火墙状态
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate

# 临时关闭（测试用）
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate off
```

**测试连接**：
```bash
# 在电脑上
curl http://192.168.1.100:5173

# 应该返回 HTML
```

### 问题 2：连接失败 "Unauthorized"

**原因**：Token 不正确

**解决方案**：
1. 重新获取 token：
   ```javascript
   const info = await window.GetRemoteControlInfo()
   console.log('Token:', info.token)
   ```
2. 确保复制完整（无空格）
3. 重新输入并连接

### 问题 3：SSE 连接失败

**症状**：右下角显示 🔴

**检查**：
1. 浏览器控制台（F12）查看错误
2. 检查 SSE 端点：
   ```
   http://192.168.1.100:8080/api/events?token=xxx
   ```
3. 确认桌面端服务运行正常

**解决方案**：
1. 断开重新连接
2. 重启桌面端服务
3. 清除浏览器缓存

### 问题 4：界面显示异常

**症状**：布局错乱、文字重叠

**解决方案**：
1. 刷新页面（下拉刷新）
2. 清除浏览器缓存
3. 使用推荐浏览器（Chrome/Safari）

---

## 测试报告模板

### 基本信息

- **测试日期**：2026-01-21
- **测试人员**：[你的名字]
- **设备信息**：
  - 电脑：macOS / Windows / Linux
  - 手机：iPhone / Android
  - 浏览器：Chrome / Safari

### 测试结果

| 功能 | 状态 | 备注 |
|------|------|------|
| 桌面端服务启动 | ✅/❌ | |
| 手机端应用启动 | ✅/❌ | |
| 局域网连接 | ✅/❌ | |
| 聊天功能 | ✅/❌ | |
| 文件浏览 | ✅/❌ | |
| 终端查看 | ✅/❌ | |
| SSE 实时更新 | ✅/❌ | |
| 断线重连 | ✅/❌ | |

### 性能数据

- **连接延迟**：___ ms
- **消息延迟**：___ ms
- **稳定性**：连接 ___ 分钟无断开

### 问题记录

1. **问题描述**：
   - 现象：
   - 重现步骤：
   - 解决方案：

### 总体评价

- [ ] 功能完整
- [ ] 性能良好
- [ ] 稳定可靠
- [ ] 可以投入使用

---

## 下一步

测试完成后：

1. **记录问题**：将发现的问题记录下来
2. **优化改进**：根据测试结果优化
3. **生产部署**：构建生产版本
4. **用户培训**：编写用户手册

---

**祝测试顺利！** 🎉
