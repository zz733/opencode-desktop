# 账号切换问题诊断

## 问题现状

用户反馈：点击切换账号按钮后，OpenCode 插件中的账号没有变化。

## 根本原因分析

经过代码审查和文件检查，发现了以下情况：

### 1. 两个不同的应用

系统中存在两个独立的应用：

1. **myapp** (当前开发的应用)
   - 数据目录：`~/Library/Application Support/OpenCode/KiroAccountManager/`
   - 账号文件：`data/accounts.json.enc` (加密存储)
   - 这是我们正在开发的 Wails 应用

2. **Kiro Account Manager** (独立的 Tauri 应用)
   - 数据目录：`~/Library/Application Support/.kiro-account-manager/`
   - 账号文件：`accounts.json` (明文存储)
   - 这是另一个独立的账号管理应用

### 2. OpenCode 插件配置

OpenCode 插件使用的账号配置文件：
- 路径：`~/.config/opencode/kiro-accounts.json`
- 当前内容：`builder-id@aws.amazon.com` (realEmail: `3815228@qq.com`)

### 3. 用户看到的界面

用户提到的账号 `dongthibichthaoyv6t8@k30.huas.edu.vn` 存在于 **Kiro Account Manager** 应用中，而不是 myapp 中。

## 代码验证

### 后端代码 (已正确实现)

1. `account_manager.go` 的 `SwitchAccount` 函数：
   - ✅ 正确调用了 `ApplyAccountToOpenCode`
   - ✅ 添加了详细的日志输出到 stderr 和文件

2. `opencode_kiro.go` 的 `ApplyAccountToOpenCode` 函数：
   - ✅ 正确写入 `~/.config/opencode/kiro-accounts.json`
   - ✅ 只保留一个账号（当前激活的账号）
   - ✅ 添加了详细的日志输出

3. `app.go` 的 `SwitchKiroAccount` API：
   - ✅ 正确调用了 `accountMgr.SwitchAccount`
   - ✅ 添加了日志输出

### 前端代码 (已正确实现)

1. `KiroAccountManager.vue` 的 `switchAccount` 函数：
   - ✅ 正确调用了后端 API `SwitchKiroAccount`
   - ✅ 添加了详细的日志输出
   - ✅ 按钮添加了 `type="button"` 和 `@click.stop.prevent`

2. 配额显示修复：
   - ✅ 添加了 `v-if="account.quota && account.quota.main"` 检查
   - ✅ 使用可选链操作符 `?.` 避免 undefined 错误

## 诊断步骤

### 步骤 1：确认使用的是哪个应用

请确认您打开的是哪个应用：

- **myapp** (Wails 应用)：窗口标题应该显示 "OpenCode" 或类似名称
- **Kiro Account Manager** (Tauri 应用)：窗口标题显示 "Kiro Account Manager"

### 步骤 2：检查 myapp 中的账号

如果您使用的是 myapp：

1. 打开应用
2. 进入 "设置 > 插件 > Kiro Auth > 账号管理"
3. 查看账号列表中是否有 `dongthibichthaoyv6t8@k30.huas.edu.vn`

如果没有这个账号，需要先添加：
- 点击"添加账号"
- 选择"Refresh Token"方式
- 输入该账号的 Refresh Token

### 步骤 3：运行测试脚本

```bash
cd myapp
./test_switch_account.sh
```

这个脚本会：
1. 显示当前 OpenCode 配置
2. 等待您点击切换按钮
3. 显示切换后的配置
4. 显示详细的日志输出

### 步骤 4：查看日志

切换账号时，应该在以下位置看到日志：

1. **终端输出** (运行 `wails dev` 的终端)
2. **日志文件** (`/tmp/kiro-account-manager.log`)

预期的日志输出：
```
========================================
  → AccountManager.SwitchAccount 开始 (id=xxx)
  ✓ 找到账号: xxx@xxx.com (ID: xxx)
  → 取消旧账号激活状态: xxx@xxx.com
  ✓ 设置新账号为激活状态: xxx@xxx.com
  → 应用账号到 OpenCode...
  
========================================
  → ApplyAccountToOpenCode 开始
  → 账号 ID: xxx
  → 账号邮箱: xxx@xxx.com
  ✓ 创建 OpenCode 账号结构完成
  → 目标文件路径: ~/.config/opencode/kiro-accounts.json
  → 开始写入文件...
  ✓ 文件写入成功！
  ✓ 验证: 文件中账号数 = 1
  ✓ 验证: 第一个账号邮箱 = xxx@xxx.com
========================================
```

## 解决方案

### 如果您使用的是 Kiro Account Manager 应用

那个应用是独立的，与 myapp 无关。它有自己的切换逻辑。

### 如果您使用的是 myapp

1. **确保账号已添加**：在 myapp 中添加您想切换到的账号
2. **点击切换按钮**：在账号卡片上点击切换按钮（双箭头图标）
3. **查看日志**：检查终端或日志文件中的输出
4. **验证文件**：运行 `cat ~/.config/opencode/kiro-accounts.json | jq '.accounts[0].email'`
5. **重启 OpenCode**：切换后需要重启 OpenCode 才能生效

## 下一步行动

请告诉我：

1. 您打开的是哪个应用？（myapp 还是 Kiro Account Manager）
2. 在该应用的账号列表中，是否有 `dongthibichthaoyv6t8@k30.huas.edu.vn` 这个账号？
3. 运行测试脚本后，看到了什么日志输出？

这样我才能准确定位问题并提供解决方案。
