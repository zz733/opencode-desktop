# Kiro 账号管理器 - 测试说明

## 已完成的修复

### 1. 配额显示修复
- ✅ 配额计算已改为累加模式：主配额 + 试用配额 + 赠送配额
- ✅ 使用新的 Kiro API 客户端获取准确的配额数据
- ✅ 配额刷新功能已连接到真实 API

### 2. 日志输出增强
- ✅ 前端添加了详细的控制台日志
- ✅ 后端添加了完整的调试日志
- ✅ 所有关键操作都有日志输出

### 3. API 集成
- ✅ 使用真实的 Kiro API 端点
- ✅ Token 刷新功能正常工作
- ✅ 配额查询功能正常工作
- ✅ 账号切换功能正常工作

## 如何测试

### 方法 1：使用脚本运行（推荐）

```bash
cd myapp
./run_with_logs.sh
```

这样可以在终端看到所有日志输出。

### 方法 2：直接运行

```bash
cd myapp
./build/bin/myapp.app/Contents/MacOS/myapp
```

## 测试步骤

### 1. 添加账号测试

1. 点击"添加账号"按钮
2. 选择"Refresh Token"方式
3. 粘贴您的 Refresh Token
4. 点击"添加账号"
5. **查看终端输出**，应该看到：
   ```
   API 调用: AddKiroAccount (method=token)
   → addAccountByToken 开始
   创建 Kiro API 客户端...
   调用 RefreshKiroToken...
   ✓ Token 刷新成功
   调用 GetKiroUsageLimits...
   ✓ 配额信息获取成功
   主配额: Used=X, Total=Y
   试用配额: Used=X, Total=Y
   赠送配额[0]: Used=X, Total=Y
   累计配额: Used=X, Total=Y
   ✓ 账号添加成功
   ```

### 2. 刷新配额测试

1. 找到任意账号卡片
2. 点击"刷新"按钮（循环箭头图标）
3. **查看终端输出**，应该看到：
   ```
   === refreshAccountQuota 被调用 === kiro-xxxxx
   → 调用 RefreshKiroQuota...
   === API 调用: RefreshKiroQuota (accountId=kiro-xxxxx) ===
   → 获取账号信息...
   ✓ 账号: your.email@example.com
   → 调用 quotaService.RefreshQuota...
   === RefreshQuota 开始 (accountID=kiro-xxxxx) ===
   → fetchQuotaFromAPI 开始
   调用 GetKiroUsageLimits...
   ✓ 配额信息获取成功
   主配额: Used=X, Total=Y
   累计配额: Used=X, Total=Y
   ✓ fetchQuotaFromAPI 完成
   === RefreshQuota 完成 ===
   ✓ 配额刷新成功
   → 获取更新后的配额...
   ✓ 配额: Used=X, Total=Y
   → 更新账号配额...
   ✓ 账号配额更新成功
   === RefreshKiroQuota 完成 ===
   ✓ RefreshKiroQuota 成功
   → 重新加载账号列表...
   ✓ 账号列表加载完成
   === refreshAccountQuota 完成 ===
   ```

### 3. 切换账号测试

1. 找到任意非激活状态的账号
2. 点击"切换"按钮（双箭头图标）
3. **查看终端输出**，应该看到：
   ```
   === switchAccount 被调用 === kiro-xxxxx your.email@example.com
   → 调用 SwitchKiroAccount...
   === API 调用: SwitchKiroAccount (id=kiro-xxxxx) ===
   → 调用 accountMgr.SwitchAccount...
   → AccountManager.SwitchAccount 开始 (id=kiro-xxxxx)
   ✓ 找到账号: your.email@example.com
   → 取消旧账号激活状态: old.email@example.com
   ✓ 设置新账号为激活状态: your.email@example.com
   → 应用账号到 OpenCode...
   ✓ 成功应用到 OpenCode
   → 保存账号数据...
   ✓ 账号数据保存成功
   ✓ 事件已发送
   ✓ AccountManager.SwitchAccount 完成
   ✓ SwitchKiroAccount 成功
   → 重新加载账号列表...
   ✓ 账号列表加载完成
   === switchAccount 完成 ===
   ```

## 预期结果

### 配额显示
- 配额条应该显示累加后的总配额（主 + 试用 + 赠送）
- 使用量应该正确显示（不再是 0）
- 百分比应该正确计算

### 按钮功能
- 刷新按钮：点击后应该有加载动画，配额数据应该更新
- 切换按钮：点击后账号状态应该改变，"当前使用"标签应该移动到新账号
- 编辑按钮：打开编辑对话框
- 删除按钮：打开删除确认对话框

### 日志输出
- 每次操作都应该在终端看到详细的日志
- 如果没有日志输出，说明前端函数没有被调用，需要检查浏览器控制台

## 常见问题

### Q: 点击按钮没有任何反应
**A:** 打开浏览器开发者工具（F12 或 Cmd+Option+I），查看 Console 标签页是否有错误信息。

### Q: 终端没有日志输出
**A:** 
1. 确保使用 `./run_with_logs.sh` 脚本运行
2. 检查浏览器控制台是否有 JavaScript 错误
3. 确认前端函数是否被调用（应该能看到 `=== switchAccount 被调用 ===` 等日志）

### Q: 配额显示为 0/550
**A:** 
1. 点击刷新按钮更新配额
2. 查看终端日志，确认 API 调用是否成功
3. 如果 API 返回错误，可能是 Token 已过期，需要重新添加账号

### Q: 切换账号不成功
**A:**
1. 查看终端日志，找到具体的错误信息
2. 确认 OpenCode 配置文件路径是否正确
3. 检查是否有文件权限问题

## 下一步

如果测试中发现问题，请：
1. 保存终端的完整日志输出
2. 截图浏览器控制台的错误信息
3. 描述具体的操作步骤和预期结果
4. 提供这些信息以便进一步调试
