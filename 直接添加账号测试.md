# 直接添加 Kiro 账号测试

## 问题分析

当前 UI 显示的是 "Test Account" (user@example.com, 配额 0/100)，但这不是真实数据。

可能的原因：
1. 后端返回空数组，前端显示了占位数据
2. 添加账号时出错，但没有显示错误信息
3. 数据没有正确保存到文件

## 验证步骤

### 1. 检查后端是否初始化

在浏览器开发者工具的 Console 中执行：

```javascript
// 获取账号列表
GetKiroAccounts().then(accounts => {
  console.log('账号数量:', accounts ? accounts.length : 0);
  console.log('账号数据:', accounts);
}).catch(err => {
  console.error('获取失败:', err);
});
```

### 2. 手动添加账号

在浏览器开发者工具的 Console 中执行：

```javascript
// 添加账号
const data = {
  refreshToken: "aorAAAAAGnLGQgY_JGCEaAu31zq9-VgAlp1em-13e_w6H4pNt4aq17R2Ot_1LNtlrZASD8jR6JKRg5NVUWG5HZRdgBkc0:MGUCMQCuOP9WeTpHKpyyFSo/Q6M0NDCBKOvnnkPq15udRiV6EsyXa5lDxb+beSdukMSZ7s4CMCcIfnOZwQkXyBtPAT5sFPQdyBl8iMDZv7VBM/3l99RKBeOVSGKbqtVU6aIAik539A",
  displayName: "我的 Kiro 账号",
  notes: "测试添加"
};

AddKiroAccount("token", data).then(() => {
  console.log('✓ 添加成功');
  // 重新获取列表
  return GetKiroAccounts();
}).then(accounts => {
  console.log('新的账号列表:', accounts);
}).catch(err => {
  console.error('✗ 添加失败:', err);
});
```

### 3. 检查文件系统

在终端执行：

```bash
# 检查数据目录
ls -la ~/.config/opencode/data/

# 如果目录存在，查看文件
ls -la ~/.config/opencode/data/accounts.json.enc

# 查看文件大小和修改时间
stat ~/.config/opencode/data/accounts.json.enc
```

### 4. 查看应用日志

在运行 `wails dev` 的终端中查看输出，特别注意：
- 是否有 "添加账号" 相关的日志
- 是否有错误信息
- 是否有 API 调用失败的提示

## 可能的问题和解决方案

### 问题 1：权限问题

如果创建目录失败，可能是权限问题：

```bash
# 手动创建目录
mkdir -p ~/.config/opencode/data
mkdir -p ~/.config/opencode/backups

# 设置权限
chmod 755 ~/.config/opencode/data
chmod 755 ~/.config/opencode/backups
```

### 问题 2：API 调用失败

检查网络连接：

```bash
# 测试 Kiro Auth API
curl -I https://prod.us-east-1.auth.desktop.kiro.dev

# 测试 Kiro Usage API
curl -I https://codewhisperer.us-east-1.amazonaws.com
```

### 问题 3：前端缓存

清除浏览器缓存并重新加载：
1. 打开开发者工具（F12）
2. 右键点击刷新按钮
3. 选择"清空缓存并硬性重新加载"

### 问题 4：后端未初始化

重启应用：

```bash
# 停止当前运行的应用（Ctrl+C）
# 重新启动
cd myapp
wails dev
```

## 预期结果

成功添加账号后，应该看到：

1. **终端输出**：
   ```
   创建配置管理器成功
   初始化配置成功
   数据目录: /Users/xxx/.config/opencode/data
   刷新 Token 成功
   获取配额成功
   账号添加成功
   ```

2. **文件系统**：
   ```
   ~/.config/opencode/data/accounts.json.enc (存在，大小 > 0)
   ```

3. **UI 显示**：
   - 邮箱: luuquanglucyrmsj@k25.huas.edu.vn
   - 订阅: KIRO FREE
   - 主配额: 0/50
   - 试用配额: 0/500

## 调试命令

```bash
# 完整的环境检查
cd myapp
./verify_kiro_setup.sh

# 查看应用进程
ps aux | grep myapp

# 查看端口占用
lsof -i :34115  # Wails 默认端口
```
